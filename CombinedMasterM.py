#!/usr/bin/env python
AV='%.1f%%'
AU='GrandTotal_column_wise'
AT='Percentage of FE with Mahindra'
A8='Private Auction'
A7='Banks Auction'
A5='Ediig'
A4='Cardekho'
A3='Superbids'
A2='Bidkaro'
A1='Grand Total'
A0='CTE'
z='Verticle'
y='FE'
x='CE'
w='CV'
v='4W'
Y='3W'
X='2W'
W='center right'
V='Companies'
U='%1.1f%%'
T='GrandTotal'
S='png'
P='tight'
O=True
M='percentage'
L='Mahindra'
E='Client'
D='Make'
B='Comp Name'
A='No of Unique Listings'
import pandas as F,numpy as CG,matplotlib.pyplot as C,openpyxl
from openpyxl import Workbook as AW
import matplotlib.pyplot as C
from openpyxl.drawing.image import Image
from io import BytesIO as R
Q=[]
H=F.read_csv('D:/Automation/OutputM//bidkaro//masterfile_bidkaro.csv')
I=F.read_csv('D:/Automation/OutputM//superbids//masterfile_superbids.csv')
J=F.read_csv('D:/Automation/OutputM//cardekho//masterfile_cardekho.csv')
G=F.read_csv('D:/Automation/OutputM//ediig//masterfile_ediig.csv')
K=F.read_csv('D:/Automation/OutputM//cardekho//masterfile_cardekho.csv')
G
AX=H.groupby(B).size().reset_index(name=A)
AY=I.groupby(B).size().reset_index(name=A)
AZ=J.groupby(B).size().reset_index(name=A)
Aa=G.groupby(B).size().reset_index(name=A)
Ab=K.groupby(B).size().reset_index(name=A)
b=F.concat([AX,AY,AZ,Aa,Ab],ignore_index=O)
b[M]=(b[A]/b[A].sum()*100).round(1)
b
Ac=F.DataFrame({B:[T],A:b[A].sum(),M:100},index=[b.shape[0]])
b=F.concat([b,Ac])
b
AA=R()
C.figure(figsize=(8,6))
N,Z,a=C.pie(b[A][:-1],labels=b[B][:-1],autopct=U,startangle=140)
C.title('Percentage of Unique Listings with Mahindra')
C.legend(N,b[B][:-1],title=V,loc=W,bbox_to_anchor=(1,0,.5,1))
C.savefig(AA,format=S,bbox_inches=P)
C.close()
Q.append(AA)
Ad=H[H[E]!=L].groupby(B).size().reset_index(name=A)
Ae=I[I[E]!=L].groupby(B).size().reset_index(name=A)
Af=J[J[E]!=L].groupby(B).size().reset_index(name=A)
Ag=G[G[E]!=L].groupby(B).size().reset_index(name=A)
Ah=K[K[E]!=L].groupby(B).size().reset_index(name=A)
c=F.concat([Ad,Ae,Af,Ag,Ah],ignore_index=O)
c[M]=(c[A]/c[A].sum()*100).round(1)
c
Ai=F.DataFrame({B:[T],A:c[A].sum(),M:100},index=[c.shape[0]])
c=F.concat([c,Ai])
c
AB=R()
C.figure(figsize=(8,6))
N,Z,a=C.pie(c[A][:-1],labels=c[B][:-1],autopct=U,startangle=140)
C.title('Percentage of Unique Listings without Mahindra')
C.legend(N,c[B][:-1],title=V,loc=W,bbox_to_anchor=(1,0,.5,1))
C.savefig('combined_count_withoutmanhindra.png',bbox_inches=P)
C.savefig(AB,format=S,bbox_inches=P)
C.close()
Q.append(AB)
Aj=H[~H[D].isin([X,Y])].groupby(B).size().reset_index(name=A)
Ak=I[~I[D].isin([X,Y])].groupby(B).size().reset_index(name=A)
Al=J[~J[D].isin([X,Y])].groupby(B).size().reset_index(name=A)
Am=G[~G[D].isin([X,Y])].groupby(B).size().reset_index(name=A)
An=K[~K[D].isin([X,Y])].groupby(B).size().reset_index(name=A)
f=F.concat([Aj,Ak,Al,Am,An],ignore_index=O)
f[M]=(f[A]/f[A].sum()*100).round()
Ao=F.DataFrame({B:[T],A:f[A].sum(),M:100},index=[f.shape[0]])
f=F.concat([f,Ao])
f
AC=R()
C.figure(figsize=(8,6))
N,Z,a=C.pie(f[A][:-1],labels=f[B][:-1],autopct=U,startangle=140)
C.title('Percentage of listing without 2W and 3W')
C.legend(N,f[B][:-1],title=V,loc=W,bbox_to_anchor=(1,0,.5,1))
C.savefig(AC,format=S,bbox_inches=P)
C.close()
Q.append(AC)
Ap=H[H[D]==X].groupby(B).size().reset_index(name=A)
Aq=I[I[D]==X].groupby(B).size().reset_index(name=A)
Ar=J[J[D]==X].groupby(B).size().reset_index(name=A)
As=G[G[D]==X].groupby(B).size().reset_index(name=A)
At=K[K[D]==X].groupby(B).size().reset_index(name=A)
g=F.concat([Ap,Aq,Ar,As,At],ignore_index=O)
g[M]=(g[A]/g[A].sum()*100).round(1)
Au=F.DataFrame({B:[T],A:g[A].sum(),M:100},index=[g.shape[0]])
g=F.concat([g,Au])
g
AD=R()
C.figure(figsize=(8,6))
N,Z,a=C.pie(g[A][:-1],labels=g[B][:-1],autopct=U,startangle=140)
C.title('Percentage of 2W with Mahindra')
C.legend(N,g[B][:-1],title=V,loc=W,bbox_to_anchor=(1,0,.5,1))
C.savefig(AD,format=S,bbox_inches=P)
C.close()
Q.append(AD)
Av=H[H[D]==Y].groupby(B).size().reset_index(name=A)
Aw=I[I[D]==Y].groupby(B).size().reset_index(name=A)
Ax=J[J[D]==Y].groupby(B).size().reset_index(name=A)
Ay=G[G[D]==Y].groupby(B).size().reset_index(name=A)
Az=K[K[D]==Y].groupby(B).size().reset_index(name=A)
d=F.concat([Av,Aw,Ax,Ay,Az],ignore_index=O)
d[M]=(d[A]/d[A].sum()*100).round(1)
d
A_=F.DataFrame({B:[T],A:d[A].sum(),M:100},index=[d.shape[0]])
d=F.concat([d,A_])
d
AE=R()
C.figure(figsize=(8,6))
N,Z,a=C.pie(d[A][:-1],labels=d[B][:-1],autopct=U,startangle=140)
C.title('Percentage of 3W with Mahindra')
C.legend(N,d[B][:-1],title=V,loc=W,bbox_to_anchor=(1,0,.5,1))
C.savefig(AE,format=S,bbox_inches=P)
C.close()
Q.append(AE)
B0=H[H[D]==v].groupby(B).size().reset_index(name=A)
B1=I[I[D]==v].groupby(B).size().reset_index(name=A)
B2=J[J[D]==v].groupby(B).size().reset_index(name=A)
B3=G[G[D]==v].groupby(B).size().reset_index(name=A)
B4=K[K[D]==v].groupby(B).size().reset_index(name=A)
h=F.concat([B0,B1,B2,B3,B4],ignore_index=O)
h[M]=(h[A]/h[A].sum()*100).round(1)
B5=F.DataFrame({B:[T],A:h[A].sum(),M:100},index=[h.shape[0]])
h=F.concat([h,B5])
h
AF=R()
C.figure(figsize=(8,6))
N,Z,a=C.pie(h[A][:-1],labels=h[B][:-1],autopct=U,startangle=140)
C.title('Percentage of 4W with Mahindra')
C.legend(N,h[B][:-1],title=V,loc=W,bbox_to_anchor=(1,0,.5,1))
C.savefig(AF,format=S,bbox_inches=P)
C.close()
Q.append(AF)
B6=H[H[D]==w].groupby(B).size().reset_index(name=A)
B7=I[I[D]==w].groupby(B).size().reset_index(name=A)
B8=J[J[D]==w].groupby(B).size().reset_index(name=A)
B9=G[G[D]==w].groupby(B).size().reset_index(name=A)
BA=K[K[D]==w].groupby(B).size().reset_index(name=A)
i=F.concat([B6,B7,B8,B9,BA],ignore_index=O)
i[M]=(i[A]/i[A].sum()*100).round(1)
BB=F.DataFrame({B:[T],A:i[A].sum(),M:100},index=[i.shape[0]])
i=F.concat([i,BB])
i
AG=R()
C.figure(figsize=(8,6))
N,Z,a=C.pie(i[A][:-1],labels=i[B][:-1],autopct=U,startangle=140)
C.title('Percentage of CV with Mahindra')
C.legend(N,i[B][:-1],title=V,loc=W,bbox_to_anchor=(1,0,.5,1))
C.savefig(AG,format=S,bbox_inches=P)
C.close()
Q.append(AG)
BC=H[H[D]==x].groupby(B).size().reset_index(name=A)
BD=I[I[D]==x].groupby(B).size().reset_index(name=A)
BE=J[J[D]==x].groupby(B).size().reset_index(name=A)
BF=G[G[D]==x].groupby(B).size().reset_index(name=A)
BG=K[K[D]==x].groupby(B).size().reset_index(name=A)
j=F.concat([BC,BD,BE,BF,BG],ignore_index=O)
j[M]=(j[A]/j[A].sum()*100).round(1)
BH=F.DataFrame({B:[T],A:j[A].sum(),M:100},index=[j.shape[0]])
j=F.concat([j,BH])
j
AH=R()
C.figure(figsize=(8,6))
N,Z,a=C.pie(j[A][:-1],labels=j[B][:-1],autopct=U,startangle=140)
C.title('Percentage of CE with Mahindra')
C.legend(N,j[B][:-1],title=V,loc=W,bbox_to_anchor=(1,0,.5,1))
C.savefig(AH,format=S,bbox_inches=P)
C.close()
Q.append(AH)
BI=H[H[D]==y].groupby(B).size().reset_index(name=A)
BJ=I[I[D]==y].groupby(B).size().reset_index(name=A)
BK=J[J[D]==y].groupby(B).size().reset_index(name=A)
BL=G[G[D]==y].groupby(B).size().reset_index(name=A)
BM=K[K[D]==y].groupby(B).size().reset_index(name=A)
k=F.concat([BI,BJ,BK,BL,BM],ignore_index=O)
k[M]=(k[A]/k[A].sum()*100).round(1)
BN=F.DataFrame({B:[T],A:k[A].sum(),M:100},index=[k.shape[0]])
k=F.concat([k,BN])
k
AI=R()
C.figure(figsize=(8,6))
N,Z,a=C.pie(k[A][:-1],labels=k[B][:-1],autopct=U,startangle=140)
C.title(AT)
C.legend(N,k[B][:-1],title=V,loc=W,bbox_to_anchor=(1,0,.5,1))
C.savefig(AI,format=S,bbox_inches=P)
C.close()
Q.append(AI)
BO=H[(H[D]==X)&(H[E]!=L)].groupby(B).size().reset_index(name=A)
BP=I[(I[D]==X)&(I[E]!=L)].groupby(B).size().reset_index(name=A)
BQ=J[(J[D]==X)&(J[E]!=L)].groupby(B).size().reset_index(name=A)
BR=G[(G[D]==X)&(G[E]!=L)].groupby(B).size().reset_index(name=A)
BS=K[(K[D]==X)&(K[E]!=L)].groupby(B).size().reset_index(name=A)
l=F.concat([BO,BP,BQ,BR,BS],ignore_index=O)
l[M]=(l[A]/l[A].sum()*100).round(1)
BT=F.DataFrame({B:[T],A:l[A].sum(),M:100},index=[l.shape[0]])
l=F.concat([l,BT])
l
AJ=R()
C.figure(figsize=(8,6))
N,Z,a=C.pie(l[A][:-1],labels=l[B][:-1],autopct=U,startangle=140)
C.title('Percentage of 2W without Mahindra')
C.legend(N,l[B][:-1],title=V,loc=W,bbox_to_anchor=(1,0,.5,1))
C.savefig(AJ,format=S,bbox_inches=P)
C.close()
Q.append(AJ)
BU=H[(H[D]==Y)&(H[E]!=L)].groupby(B).size().reset_index(name=A)
BV=I[(I[D]==Y)&(I[E]!=L)].groupby(B).size().reset_index(name=A)
BW=J[(J[D]==Y)&(J[E]!=L)].groupby(B).size().reset_index(name=A)
BX=G[(G[D]==Y)&(G[E]!=L)].groupby(B).size().reset_index(name=A)
BY=K[(K[D]==Y)&(K[E]!=L)].groupby(B).size().reset_index(name=A)
m=F.concat([BU,BV,BW,BX,BY],ignore_index=O)
m[M]=(m[A]/m[A].sum()*100).round(1)
BZ=F.DataFrame({B:[T],A:m[A].sum(),M:100},index=[m.shape[0]])
m=F.concat([m,BZ])
m
AK=R()
C.figure(figsize=(8,6))
N,Z,a=C.pie(m[A][:-1],labels=m[B][:-1],autopct=U,startangle=140)
C.title('Percentage of 3W without Mahindra')
C.legend(N,m[B][:-1],title=V,loc=W,bbox_to_anchor=(1,0,.5,1))
C.savefig('count_withoutm_3W.png',bbox_inches=P)
C.savefig(AK,format=S,bbox_inches=P)
C.close()
Q.append(AK)
Ba=H[(H[D]==v)&(H[E]!=L)].groupby(B).size().reset_index(name=A)
Bb=I[(I[D]==v)&(I[E]!=L)].groupby(B).size().reset_index(name=A)
Bc=J[(J[D]==v)&(J[E]!=L)].groupby(B).size().reset_index(name=A)
Bd=G[(G[D]==v)&(G[E]!=L)].groupby(B).size().reset_index(name=A)
Be=K[(K[D]==v)&(K[E]!=L)].groupby(B).size().reset_index(name=A)
n=F.concat([Ba,Bb,Bc,Bd,Be],ignore_index=O)
n[M]=(n[A]/n[A].sum()*100).round(1)
Bf=F.DataFrame({B:[T],A:n[A].sum(),M:100},index=[n.shape[0]])
n=F.concat([n,Bf])
n
AL=R()
C.figure(figsize=(8,6))
N,Z,a=C.pie(n[A][:-1],labels=n[B][:-1],autopct=U,startangle=140)
C.title('Percentage of 4W without Mahindra')
C.legend(N,n[B][:-1],title=V,loc=W,bbox_to_anchor=(1,0,.5,1))
C.savefig(AL,format=S,bbox_inches=P)
C.close()
Q.append(AL)
Bg=H[(H[D]==w)&(H[E]!=L)].groupby(B).size().reset_index(name=A)
Bh=I[(I[D]==w)&(I[E]!=L)].groupby(B).size().reset_index(name=A)
Bi=J[(J[D]==w)&(J[E]!=L)].groupby(B).size().reset_index(name=A)
Bj=G[(G[D]==w)&(G[E]!=L)].groupby(B).size().reset_index(name=A)
Bk=K[(K[D]==w)&(K[E]!=L)].groupby(B).size().reset_index(name=A)
o=F.concat([Bg,Bh,Bi,Bj,Bk],ignore_index=O)
o[M]=(o[A]/o[A].sum()*100).round(1)
Bl=F.DataFrame({B:[T],A:o[A].sum(),M:100},index=[o.shape[0]])
o=F.concat([o,Bl])
o
AM=R()
C.figure(figsize=(8,6))
N,Z,a=C.pie(o[A][:-1],labels=o[B][:-1],autopct=U,startangle=140)
C.title('Percentage of CV without Mahindra')
C.legend(N,o[B][:-1],title=V,loc=W,bbox_to_anchor=(1,0,.5,1))
C.savefig(AM,format=S,bbox_inches=P)
C.close()
Q.append(AM)
Bm=H[(H[D]==x)&(H[E]!=L)].groupby(B).size().reset_index(name=A)
Bn=I[(I[D]==x)&(I[E]!=L)].groupby(B).size().reset_index(name=A)
Bo=J[(J[D]==x)&(J[E]!=L)].groupby(B).size().reset_index(name=A)
Bp=G[(G[D]==x)&(G[E]!=L)].groupby(B).size().reset_index(name=A)
Bq=K[(K[D]==x)&(K[E]!=L)].groupby(B).size().reset_index(name=A)
p=F.concat([Bm,Bn,Bo,Bp,Bq],ignore_index=O)
p[M]=(p[A]/p[A].sum()*100).round(1)
Br=F.DataFrame({B:[T],A:p[A].sum(),M:100},index=[p.shape[0]])
p=F.concat([p,Br])
p
AN=R()
C.figure(figsize=(8,6))
N,Z,a=C.pie(p[A][:-1],labels=p[B][:-1],autopct=U,startangle=140)
C.title('Percentage of CE without Mahindra')
C.legend(N,p[B][:-1],title=V,loc=W,bbox_to_anchor=(1,0,.5,1))
C.savefig(AN,format=S,bbox_inches=P)
C.close()
Q.append(AN)
Bs=H[(H[D]==y)&(H[E]!=L)].groupby(B).size().reset_index(name=A)
Bt=I[(I[D]==y)&(I[E]!=L)].groupby(B).size().reset_index(name=A)
Bu=J[(J[D]==y)&(J[E]!=L)].groupby(B).size().reset_index(name=A)
Bv=G[(G[D]==y)&(G[E]!=L)].groupby(B).size().reset_index(name=A)
Bw=K[(K[D]==y)&(K[E]!=L)].groupby(B).size().reset_index(name=A)
q=F.concat([Bs,Bt,Bu,Bv,Bw],ignore_index=O)
q[M]=(q[A]/q[A].sum()*100).round(1)
Bx=F.DataFrame({B:[T],A:q[A].sum(),M:100},index=[q.shape[0]])
q=F.concat([q,Bx])
q
AO=R()
C.figure(figsize=(8,6))
N,Z,a=C.pie(q[A][:-1],labels=q[B][:-1],autopct=U,startangle=140)
C.title(AT)
C.legend(N,q[B][:-1],title=V,loc=W,bbox_to_anchor=(1,0,.5,1))
C.savefig(AO,format=S,bbox_inches=P)
C.show()
Q.append(AO)
By=H[H[z]==A7].groupby(E).size().reset_index(name=A2).sort_values(by=E)
Bz=I[I[z]==A7].groupby(E).size().reset_index(name=A3).sort_values(by=E)
B_=J[J[z]==A7].groupby(E).size().reset_index(name=A4).sort_values(by=E)
C0=G[G[z]==A7].groupby(E).size().reset_index(name=A5).sort_values(by=E)
C1=K[K[z]==A7].groupby(E).size().reset_index(name=A0).sort_values(by=E)
e=F.concat([By,Bz,B_,C0,C1],ignore_index=O)
e=e.fillna(0)
e[A1]=e.iloc[:,1:].sum(axis=1)
e
C2=F.DataFrame({E:[AU],A2:e[A2].sum(),A3:e[A3].sum(),A4:e[A4].sum(),A5:e[A5].sum(),A0:e[A0].sum(),A1:e[A1].sum()},index=[e.shape[0]])
s=F.concat([e,C2])
s
s['CTE %']=(s[A0]/s[A1]*100).round()
s
s=s.iloc[:-1,:-2]
s.set_index(E,inplace=O)
A6=s.sum()
AP=R()
C.figure(figsize=(6,6))
C.pie(A6,labels=A6.index,autopct=AV,startangle=140)
C.title('Percentage of Column Sums for Banks Auction')
C.savefig(AP,format=S,bbox_inches=P)
C.close()
Q.append(AP)
C3=H[H[z]==A8].groupby(E).size().reset_index(name=A2).sort_values(by=E)
C4=I[I[z]==A8].groupby(E).size().reset_index(name=A3).sort_values(by=E)
C5=J[J[z]==A8].groupby(E).size().reset_index(name=A4).sort_values(by=E)
C6=G[G[z]==A8].groupby(E).size().reset_index(name=A5).sort_values(by=E)
C7=K[K[z]==A8].groupby(E).size().reset_index(name=A0).sort_values(by=E)
r=F.concat([C3,C4,C5,C6,C7],ignore_index=O)
r=r.fillna(0)
r[A1]=r.iloc[:,1:].sum(axis=1)
C8=F.DataFrame({E:[AU],A2:r[A2].sum(),A3:r[A3].sum(),A4:r[A4].sum(),A5:r[A5].sum(),A0:r[A0].sum(),A1:r[A1].sum()},index=[r.shape[0]])
t=F.concat([r,C8])
t
t['CTE %']=(t[A0]/t[A1]*100).round()
t
t=t.iloc[:-1,:-2]
t.set_index(E,inplace=O)
A6=t.sum()
AQ=R()
C.figure(figsize=(6,6))
C.pie(A6,labels=A6.index,autopct=AV,startangle=140)
C.title('Percentage of Column Sums for Private Auction')
C.savefig(AQ,format=S,bbox_inches=P)
C.close()
Q.append(AQ)
AR=AW()
u=AR.active
C9=['Count of all Segment','Count of all segment without mahindra','Count without 2W and 3W','2W count with mahindra','3W count with mahindra','4W count with mahindra','CV count with mahindra','CE count with mahindra','FE count with mahindra','2W count without mahindra','3W count without mahindra','4W count without mahindra','CV count without mahindra','CE count without mahindra','FE count without mahindra','Banks Auction Count','Private Auction Count']
CA=Q
CB=[b,c,f,g,d,h,i,j,k,l,m,n,o,p,q,s,t]
CH=1
for(CC,(AS,CD))in enumerate(zip(CB,CA)):
	u.append([C9[CC]]);u.append([]);u.append(AS.columns.tolist())
	for(_,CE)in AS.iterrows():u.append(CE.tolist())
	for _ in range(10):u.append([])
	u.append([]);u.append([]);A9=Image(CD);A9.width=250;A9.height=A9.width*.6;CF=f"A{u.max_row+2}";u.add_image(A9,CF);u.append([])
AR.save('D:/Automation/New folder/final_output_with.xls')
print("Data and pie chart exported to 'output_with_pie_chart.xlsx'")